<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Pie Chart</title>
		<script src="https://d3js.org/d3.v6.min.js"></script>
	</head>
	<body>
		<div id="pie-chart"></div>
		<script>
			const pieData = [
				{ name: "Rent", value: 72500 },
				{ name: "Wages", value: 92214 },
				{ name: "Utilities", value: 64502 },
				{ name: "Supplies", value: 58234 },
				{ name: "Misc", value: 62992 },
			];

			const width = 350;
			const height = Math.min(width, 350);
			const radius = Math.min(width, height) / 2;

			const arc = d3
				.arc()
				.innerRadius(radius * 0.67)
				.outerRadius(radius - 1);

			const pie = d3
				.pie()
				.padAngle(1 / radius)
				.sort(null)
				.value((d) => d.value);

			let color = d3
				.scaleOrdinal()
				.domain(pieData.map((d) => d.name))
				.range(
					d3
						.quantize(
							(t) => d3.interpolateSpectral(t * 0.8 + 0.1),
							pieData.length
						)
						.reverse()
				);

			const svg = d3
				.select("#pie-chart")
				.append("svg")
				.attr("width", width)
				.attr("height", height)
				.attr("viewBox", [-width / 2, -height / 2, width, height])
				.attr("style", "max-width: 100%; height: auto;");

			const g = svg.append("g");

			function updateChart(data) {
				// Log the data to inspect its structure
				console.log("Data being passed to updateChart:", data);

				// Ensure the data is not empty
				if (!data || data.length === 0) {
					console.error("Data array is empty or undefined");
					return;
				}

				const arcs = pie(data);

				const path = g.selectAll("path").data(arcs);

				const color = d3.scaleOrdinal(d3.schemeCategory10);

				path.join(
					(enter) => {
						enter
							.append("path")
							.attr("fill", (d) => color(d.index))
							.each(function (d) {
								this._current = d;
							}) // Store the initial angles
							.attr("d", arc);
						// .append("title")
						// .text(
						// 	(d) =>
						// 		`${
						// 			d.data.name
						// 		}: ${d.data.value.toLocaleString()}`
						// );
					},

					(update) => {
						update
							.transition() // Add transition here
							.duration(750) // Set duration of the transition
							.attrTween("d", function (d) {
								const i = d3.interpolate(this._current, d);
								this._current = i(0);
								return (t) => arc(i(t));
							});
					},

					(exit) => exit.remove() // Remove old elements
				);

				const text = g.selectAll("text").data(arcs);

				text.join(
					(enter) => {
						enter
							.append("text")
							.attr(
								"transform",
								(d) => `translate(${arc.centroid(d)})`
							)
							.call((text) => {
								text.append("tspan")
									.attr("y", "-0.4em")
									.attr("font-weight", "bold")
									.text((d) => `${d.data.name}`);
							})
							.call((text) => {
								text.filter(
									(d) => d.endAngle - d.startAngle > 0.25
								)
									.append("tspan")
									.attr("x", 0)
									.attr("y", "0.7em")
									.attr("fill-opacity", 0.7)
									.text(
										(d) =>
											`$${d.data.value.toLocaleString()}`
									);
							});
					},

					(update) => {
						update.selectAll("tspan").remove();

						update
							.attr(
								"transform",
								(d) => `translate(${arc.centroid(d)})`
							)
							.call((text) => {
								console.log("data 150", data);
								text.append("tspan")
									.attr("y", "-0.4em")
									.attr("font-weight", "bold")
									.text((d) => `${d.data.name}`);
							})
							.call((text) => {
								console.log("data 157", data);

								text.append("tspan")
									.attr("font-weight", "normal")
									.attr("x", 0)
									.attr("y", "0.7em")
									.text(
										(d) =>
											`$${d.data.value.toLocaleString()}`
									);
							});
					},

					(exit) => exit.remove() // Remove old elements
				);
			}

			function generateRandomData() {
				console.log(
					"Pie Data being passed to generateRandomData:",
					pieData
				);
				return pieData.map((d) => {
					console.log("Data being processed:", d);
					return {
						name: d.name,
						value: Math.floor(Math.random() * 300000),
					};
				});
			}

			updateChart(pieData);

			setInterval(() => {
				const newData = generateRandomData();
				updateChart(newData);
			}, 5000);
		</script>
	</body>
</html>
